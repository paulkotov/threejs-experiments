<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Day 8: Particle Systems - Creating Magic</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <!-- Day 8 Info Panel -->
  <div class="info-panel">
    <h1>‚ú® Day 8: Particle Systems</h1>
    <p><strong>Concept:</strong> Rendering Thousands of Particles Efficiently</p>
    <p><strong>Skills:</strong> THREE.Points ¬∑ BufferGeometry ¬∑ Performance</p>
    <div class="particle-info">
      <p><strong>üåå Galaxy Stats:</strong></p>
      <ul>
        <li id="particle-count">Particles: 50,000</li>
        <li id="fps-display">FPS: 60</li>
        <li>Spiral arms: 3</li>
        <li>Particle size: 0.01 - 0.05 units</li>
      </ul>
    </div>
    <div class="controls-info">
      <p><strong>‚å®Ô∏è Keyboard Controls:</strong></p>
      <ul>
        <li><kbd>Space</kbd> - Pause/Resume rotation</li>
        <li><kbd>+</kbd> / <kbd>-</kbd> - Rotation speed</li>
        <li><kbd>1</kbd> - 10,000 particles (fast)</li>
        <li><kbd>2</kbd> - 50,000 particles (default)</li>
        <li><kbd>3</kbd> - 100,000 particles (intensive)</li>
        <li><kbd>C</kbd> - Cycle color scheme</li>
        <li><kbd>R</kbd> - Regenerate galaxy</li>
      </ul>
      <p><strong>üñ±Ô∏è Mouse:</strong> Drag to rotate ¬∑ Scroll to zoom</p>
    </div>
  </div>

  <!-- ThreeJS Core Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  
  <!-- OrbitControls -->
  <script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>

  <!-- Day 8 Script -->
  <script>
    // ========================================
    // DAY 8: PARTICLE SYSTEMS
    // Learning: THREE.Points, Performance, Large-Scale Rendering
    // ========================================

    console.log('‚ú® Day 8: Particle Systems - Creating Magic');
    console.log('Generating galaxy...');

    // SCENE SETUP
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000);

    // CAMERA
    const camera = new THREE.PerspectiveCamera(
      75,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera.position.set(0, 50, 100);

    // RENDERER
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.body.appendChild(renderer.domElement);

    // ORBIT CONTROLS
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.minDistance = 20;
    controls.maxDistance = 300;

    // ========================================
    // ANIMATION VARIABLES
    // ========================================

    let isPaused = false;
    let rotationSpeed = 0.1;
    let particleCount = 50000;
    let colorScheme = 0;
    const clock = new THREE.Clock();
    let galaxy = null;

    // ========================================
    // PARTICLE GALAXY GENERATION
    // ========================================

    function generateGalaxy(count) {
      // Remove old galaxy if exists
      if (galaxy) {
        geometry.dispose();
        material.dispose();
        scene.remove(galaxy);
      }

      // Create BufferGeometry
      const geometry = new THREE.BufferGeometry();

      // Arrays for particle data
      const positions = [];
      const colors = [];
      const sizes = [];

      // Galaxy parameters
      const branches = 3;
      const spin = 1.5;
      const radius = 50;

      // Color schemes
      const colorSchemes = [
        // Scheme 0: Blue-Purple
        { inner: new THREE.Color(0x4466ff), outer: new THREE.Color(0xff44ff) },
        // Scheme 1: Red-Orange
        { inner: new THREE.Color(0xff4444), outer: new THREE.Color(0xff8844) },
        // Scheme 2: Green-Cyan
        { inner: new THREE.Color(0x44ff88), outer: new THREE.Color(0x44ffff) }
      ];

      const currentScheme = colorSchemes[colorScheme % colorSchemes.length];

      // Generate particles
      for (let i = 0; i < count; i++) {
        // POSITION
        // Distance from center (0 to radius)
        const r = Math.random() * radius;
        
        // Spiral angle
        const branchAngle = (i % branches) / branches * Math.PI * 2;
        const spinAngle = r * spin;
        
        // Add randomness
        const randomX = Math.pow(Math.random(), 3) * (Math.random() < 0.5 ? 1 : -1) * radius * 0.1;
        const randomY = Math.pow(Math.random(), 3) * (Math.random() < 0.5 ? 1 : -1) * radius * 0.1;
        const randomZ = Math.pow(Math.random(), 3) * (Math.random() < 0.5 ? 1 : -1) * radius * 0.1;
        
        // Calculate position
        const x = Math.cos(branchAngle + spinAngle) * r + randomX;
        const y = randomY;
        const z = Math.sin(branchAngle + spinAngle) * r + randomZ;
        
        positions.push(x, y, z);

        // COLOR
        // Mix colors based on distance from center
        const mixedColor = currentScheme.inner.clone();
        mixedColor.lerp(currentScheme.outer, r / radius);
        
        colors.push(mixedColor.r, mixedColor.g, mixedColor.b);

        // SIZE
        // Smaller particles further from center
        const size = Math.random() * 1.5 + 0.5;
        sizes.push(size);
      }

      // Set attributes
      geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
      geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
      geometry.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));

      // Create material
      const material = new THREE.PointsMaterial({
        size: 0.05,
        sizeAttenuation: true,
        vertexColors: true,
        transparent: true,
        opacity: 0.8,
        blending: THREE.AdditiveBlending,
        depthWrite: false
      });

      // Create Points mesh
      galaxy = new THREE.Points(geometry, material);
      scene.add(galaxy);

      console.log(`‚úì Galaxy created: ${count.toLocaleString()} particles`);
      updateUI();

      // Store geometry and material for disposal
      galaxy.userData.geometry = geometry;
      galaxy.userData.material = material;
    }

    // Generate initial galaxy
    generateGalaxy(particleCount);

    // ========================================
    // UI UPDATE
    // ========================================

    let lastTime = performance.now();
    let frames = 0;
    let fps = 60;

    function updateUI() {
      document.getElementById('particle-count').textContent = 
        `Particles: ${particleCount.toLocaleString()}`;
    }

    function updateFPS() {
      frames++;
      const currentTime = performance.now();
      if (currentTime >= lastTime + 1000) {
        fps = Math.round((frames * 1000) / (currentTime - lastTime));
        document.getElementById('fps-display').textContent = `FPS: ${fps}`;
        frames = 0;
        lastTime = currentTime;
      }
    }

    // ========================================
    // KEYBOARD CONTROLS
    // ========================================

    window.addEventListener('keydown', (event) => {
      switch(event.key) {
        case ' ':
          isPaused = !isPaused;
          console.log(isPaused ? '‚è∏Ô∏è Rotation paused' : '‚ñ∂Ô∏è Rotation resumed');
          break;
        case '+':
        case '=':
          rotationSpeed = Math.min(rotationSpeed + 0.05, 2);
          console.log(`‚è© Rotation speed: ${rotationSpeed.toFixed(2)}x`);
          break;
        case '-':
        case '_':
          rotationSpeed = Math.max(rotationSpeed - 0.05, 0.05);
          console.log(`‚è™ Rotation speed: ${rotationSpeed.toFixed(2)}x`);
          break;
        case '1':
          particleCount = 10000;
          generateGalaxy(particleCount);
          console.log('üöÄ Fast mode: 10,000 particles');
          break;
        case '2':
          particleCount = 50000;
          generateGalaxy(particleCount);
          console.log('‚ö° Default mode: 50,000 particles');
          break;
        case '3':
          particleCount = 100000;
          generateGalaxy(particleCount);
          console.log('üí´ Intensive mode: 100,000 particles');
          break;
        case 'c':
        case 'C':
          colorScheme = (colorScheme + 1) % 3;
          generateGalaxy(particleCount);
          const schemes = ['Blue-Purple', 'Red-Orange', 'Green-Cyan'];
          console.log(`üé® Color scheme: ${schemes[colorScheme]}`);
          break;
        case 'r':
        case 'R':
          generateGalaxy(particleCount);
          console.log('üîÑ Galaxy regenerated');
          break;
      }
    });

    // ========================================
    // ANIMATION LOOP
    // ========================================

    function animate() {
      requestAnimationFrame(animate);

      const delta = clock.getDelta();

      if (!isPaused && galaxy) {
        // Rotate galaxy
        galaxy.rotation.y += delta * rotationSpeed;
      }

      // Update FPS counter
      updateFPS();

      // Update controls
      controls.update();

      // Render
      renderer.render(scene, camera);
    }

    animate();

    // ========================================
    // WINDOW RESIZE
    // ========================================

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    });

    // ========================================
    // CONSOLE INFO
    // ========================================

    console.log('');
    console.log('üìö What you\'re learning:');
    console.log('  ‚úì THREE.Points - Efficient particle rendering');
    console.log('  ‚úì PointsMaterial - Particle appearance');
    console.log('  ‚úì BufferGeometry for particles');
    console.log('  ‚úì Vertex colors on particles');
    console.log('  ‚úì Size attenuation - particles scale with distance');
    console.log('  ‚úì Additive blending - glowing effect');
    console.log('  ‚úì Procedural generation - spiral galaxy algorithm');
    console.log('  ‚úì Performance optimization - rendering 100K+ particles');
    console.log('');
    console.log('üéÆ Try these:');
    console.log('  1-3: Change particle count and see FPS impact');
    console.log('  C: Cycle through color schemes');
    console.log('  R: Regenerate with different random seed');
    console.log('  +/-: Adjust rotation speed');
    console.log('');
    console.log('üí° Notice:');
    console.log('  - 50,000 particles rendering at 60 FPS!');
    console.log('  - Each particle has position, color, and size');
    console.log('  - Additive blending creates glow effect');
    console.log('  - GPU handles all particles in parallel');
  </script>
</body>

</html>
